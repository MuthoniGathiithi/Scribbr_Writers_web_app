<div class="row">
  <div class="col-md-3 mb-4">
    <div class="card border-0 shadow-sm">
      <div class="card-body text-center">
        <div class="mb-3">
          <img src="https://via.placeholder.com/100x100" alt="Profile" class="rounded-circle">
        </div>
        <h5 class="card-title"><%= user.name %></h5>
        <p class="card-text text-muted"><%= user.email %></p>
        <div class="d-grid">
          <a href="/users/profile" class="btn btn-outline-primary">Edit Profile</a>
        </div>
      </div>
    </div>
    
    <div class="card border-0 shadow-sm mt-4">
      <div class="card-header bg-white">
        <h5 class="mb-0">Quick Links</h5>
      </div>
      <div class="list-group list-group-flush">
        <a href="/dashboard" class="list-group-item list-group-item-action">
          <i class="fas fa-tachometer-alt me-2"></i> Dashboard
        </a>
        <a href="/dashboard/training" class="list-group-item list-group-item-action">
          <i class="fas fa-graduation-cap me-2"></i> Training
        </a>
        <a href="/payments" class="list-group-item list-group-item-action active">
          <i class="fas fa-credit-card me-2"></i> Payment
        </a>
        <% if(user.paymentStatus === 'completed') { %>
          <a href="/dashboard/assignments" class="list-group-item list-group-item-action">
            <i class="fas fa-tasks me-2"></i> Assignments
          </a>
        <% } %>
      </div>
    </div>
  </div>
  
  <div class="col-md-9">
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-header bg-white">
        <h5 class="mb-0">Payment Instructions</h5>
      </div>
      <div class="card-body">
        <div class="alert alert-info">
          <p class="mb-0">
            <i class="fas fa-info-circle me-2"></i>
            A one-time payment of <strong>KES 1,000</strong> is required to activate your account and access writing assignments.
          </p>
        </div>
        
        <div class="row mt-4">
          <div class="col-md-6">
            <div class="card h-100 border-0 bg-light">
              <div class="card-body">
                <h5 class="card-title text-center mb-4">How to Pay</h5>
                <ol class="list-group list-group-numbered">
                  <li class="list-group-item border-0 bg-light">Go to M-Pesa on your phone</li>
                  <li class="list-group-item border-0 bg-light">Select "Lipa na M-Pesa"</li>
                  <li class="list-group-item border-0 bg-light">Select "Pay Bill"</li>
                  <li class="list-group-item border-0 bg-light">Enter Business Number: <strong><%= mpesaTillNumber %></strong></li>
                  <li class="list-group-item border-0 bg-light">Enter Account Number: <strong><%= user.email %></strong></li>
                  <li class="list-group-item border-0 bg-light">Enter Amount: <strong>1000</strong></li>
                  <li class="list-group-item border-0 bg-light">Enter your M-Pesa PIN</li>
                  <li class="list-group-item border-0 bg-light">Confirm the transaction</li>
                  <li class="list-group-item border-0 bg-light">You will receive a confirmation SMS with a transaction code</li>
                </ol>
              </div>
            </div>
          </div>
          
          <div class="col-md-6">
            <div class="card h-100 border-0">
              <div class="card-body">
                <h5 class="card-title text-center mb-4">Submit Transaction Code</h5>
                
                <% if(user.paymentStatus === 'completed') { %>
                  <div class="alert alert-success text-center">
                    <i class="fas fa-check-circle fa-3x mb-3"></i>
                    <h5>Payment Verified</h5>
                    <p class="mb-0">Your payment has been verified. You can now access writing assignments.</p>
                  </div>
                  <div class="d-grid mt-3">
                    <a href="/dashboard/assignments" class="btn btn-primary">View Assignments</a>
                  </div>
                <% } else if(user.onboardingSteps.paymentSubmitted) { %>
                  <div class="alert alert-warning text-center">
                    <i class="fas fa-clock fa-3x mb-3"></i>
                    <h5>Payment Pending</h5>
                    <p class="mb-0">Your payment is being verified. This usually takes a few minutes.</p>
                    <p class="mb-0">Transaction Code: <strong><%= user.transactionCode %></strong></p>
                  </div>
                  
                  <!-- For demonstration purposes only - in a real app, this would be handled by a webhook -->
                  <form action="/payments/simulate-verification" method="POST" class="mt-3">
                    <input type="hidden" name="transactionCode" value="<%= user.transactionCode %>">
                    <div class="d-grid">
                      <button type="submit" class="btn btn-outline-primary">Simulate Verification</button>
                    </div>
                  </form>
                <% } else { %>
                  <form action="/payments/submit" method="POST" id="paymentForm" novalidate>
                    <div class="mb-3">
                      <label for="transactionCode" class="form-label">M-Pesa Transaction Code</label>
                      <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-receipt"></i></span>
                        <input
                          type="text"
                          id="transactionCode"
                          name="transactionCode"
                          class="form-control"
                          placeholder="e.g., QWE12345XYZ"
                          required
                          pattern="[A-Z0-9]{8,15}"
                          autocomplete="off"
                        />
                      </div>
                      <div class="form-text">
                        Enter the transaction code you received from M-Pesa (8-15 characters, uppercase letters and numbers only).
                      </div>
                      <div class="invalid-feedback" id="codeError"></div>
                    </div>
                    <div class="d-grid">
                      <button type="submit" class="btn btn-primary">Submit Payment</button>
                    </div>
                  </form>
                <% } %>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="card border-0 shadow-sm">
      <div class="card-header bg-white">
        <h5 class="mb-0">Payment History</h5>
      </div>
      <div class="card-body">
        <% if(payments && payments.length > 0) { %>
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Transaction Code</th>
                  <th>Amount</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                <% payments.forEach(payment => { %>
                  <tr>
                    <td><%= new Date(payment.createdAt).toLocaleDateString() %></td>
                    <td><%= payment.transactionCode %></td>
                    <td>KES <%= payment.amount.toFixed(2) %></td>
                    <td>
                      <% if(payment.status === 'verified') { %>
                        <span class="badge bg-success">Verified</span>
                      <% } else if(payment.status === 'rejected') { %>
                        <span class="badge bg-danger">Rejected</span>
                      <% } else { %>
                        <span class="badge bg-warning text-dark">Pending</span>
                      <% } %>
                    </td>
                  </tr>
                <% }); %>
              </tbody>
            </table>
          </div>
        <% } else { %>
          <p class="text-center text-muted">No payment history available.</p>
        <% } %>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('paymentForm');
    
    if (form) {
      form.addEventListener('submit', function(event) {
        const transactionCode = document.getElementById('transactionCode');
        const codeError = document.getElementById('codeError');
        let isValid = true;
        
        // Validate transaction code
        const codeRegex = /^[A-Z0-9]{8,15}$/;
        if (!codeRegex.test(transactionCode.value)) {
          codeError.textContent = 'Please enter a valid transaction code (8-15 characters, uppercase letters and numbers only)';
          transactionCode.classList.add('is-invalid');
          isValid = false;
        } else {
          transactionCode.classList.remove('is-invalid');
        }
        
        if (!isValid) {
          event.preventDefault();
        }
      });
    }
  });
</script>
